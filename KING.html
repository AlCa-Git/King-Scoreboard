<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King Scoreboard</title>
    <style>
        :root {
            --bg-primary: #1a1d23;
            --bg-secondary: #252931;
            --bg-card: #2d3139;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --accent: #00a67e;
            --accent-hover: #00c896;
            --border: #3a3f4b;
            --negative: #ff4444;
            --positive: #00e676;
            --input-bg: #1e2229;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            color: var(--text-primary);
        }
        
        /* Schermata Lista Partite */
        #partite-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .partita-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid var(--border);
            position: relative;
        }
        
        .partita-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .partita-card h3 {
            color: var(--accent);
            margin-bottom: 10px;
            padding-right: 40px;
        }
        
        .delete-card-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            transition: all 0.2s;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(255, 68, 68, 0.3);
        }
        
        .delete-card-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.6);
            background: linear-gradient(135deg, #ff6666 0%, #ee0000 100%);
        }
        
        .delete-card-btn:active {
            transform: scale(0.95);
        }
        
        .partita-info {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .new-partita-card {
            background: var(--bg-secondary);
            border: 3px dashed var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: var(--accent);
            min-height: 150px;
        }
        
        .new-partita-card:hover {
            background: var(--bg-card);
            border-color: var(--accent-hover);
            color: var(--accent-hover);
        }
        
        /* Schermata Gioco */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
        }
        
        .game-title { font-size: 1.5em; }
        
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background 0.2s;
        }
        
        .btn:hover { background: var(--accent-hover); }
        
        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover { background: var(--border); }
        
        .btn-danger {
            background: var(--negative);
        }
        
        .btn-danger:hover { opacity: 0.8; }
        
        /* Toggle button */
        .toggle-btn {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            vertical-align: middle;
        }
        
        .toggle-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        .toggle-btn::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-btn.active::after {
            left: 32px;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .players-setup {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input[type="text"], input[type="number"] {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.95em;
        }
        
        input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Tabella Stile Excel */
        .score-table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 70vh;
            background: transparent;
            border-radius: 10px;
            padding: 0;
            position: relative;
        }
        
        /* Scrollbar personalizzata */
        .score-table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        .score-table-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        
        .score-table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent) 0%, #00c896 100%);
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
        }
        
        .score-table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00c896 0%, var(--accent) 100%);
        }
        
        .score-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        
        .score-table th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 15px;
            font-weight: 600;
            border: none;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            font-size: 1.1em;
            transition: all 0.3s ease;
        }
        
        /* Evidenziazione mazziere */
        .score-table th.dealer {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.6), 0 2px 10px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }
        
        .score-table td.dealer {
            background: rgba(255, 107, 53, 0.15) !important;
            border-left: 3px solid #ff6b35 !important;
            border-right: 3px solid #ff6b35 !important;
        }
        
        .score-table th:first-child {
            border-radius: 10px 0 0 10px;
        }
        
        .score-table th:last-child {
            border-radius: 0 10px 10px 0;
        }
        
        /* Raggruppamento mani */
        .mano-group {
            background: var(--bg-card);
            margin-bottom: 8px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .mano-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* Righe espandibili */
        .mano-input-row {
            animation: slideIn 0.2s ease-out;
        }
        
        .calculated-row {
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .calculated-row:hover {
            background: rgba(0, 166, 126, 0.1) !important;
        }
        
        .calculated-row .mano-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .expand-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            margin-left: 10px;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .mano-group:nth-child(odd) {
            background: linear-gradient(135deg, var(--bg-card) 0%, #2a2d35 100%);
        }
        
        .mano-group:nth-child(even) {
            background: linear-gradient(135deg, #2a2e38 0%, var(--bg-card) 100%);
        }
        
        .score-table tbody tr {
            background: transparent;
        }
        
        .score-table td {
            border: none;
            padding: 12px;
            text-align: center;
            border-left: 1px solid rgba(58, 63, 75, 0.3);
        }
        
        .score-table td:first-child {
            border-left: none;
        }
        
        .score-table .mano-label {
            background: transparent;
            font-weight: 600;
            text-align: left;
            padding-left: 20px;
            color: var(--text-primary);
            font-size: 1.05em;
            position: relative;
        }
        
        .mano-icon {
            display: inline-block;
            margin-right: 12px;
            font-size: 1.3em;
            vertical-align: middle;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        /* Input fields migliorati */
        .score-table input[type="number"] {
            width: 100%;
            border: 2px solid transparent;
            background: rgba(30, 34, 41, 0.6);
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 1.05em;
            font-weight: 500;
        }
        
        .score-table input[type="number"]:hover {
            background: rgba(30, 34, 41, 0.9);
            transform: scale(1.05);
        }
        
        .score-table input[type="number"]:focus {
            background: var(--input-bg);
            border-color: var(--accent);
            transform: scale(1.08);
            box-shadow: 0 0 0 3px rgba(0, 166, 126, 0.2);
        }
        
        /* Checkbox custom */
        .custom-checkbox {
            width: 28px;
            height: 28px;
            cursor: pointer;
            appearance: none;
            background: rgba(30, 34, 41, 0.6);
            border: 2px solid var(--border);
            border-radius: 50%;
            position: relative;
            transition: all 0.3s;
            margin: 0 auto;
            display: block;
        }
        
        .custom-checkbox:hover {
            background: rgba(30, 34, 41, 0.9);
            transform: scale(1.15);
            border-color: var(--accent);
        }
        
        .custom-checkbox:checked {
            background: linear-gradient(135deg, var(--negative) 0%, #ff6b6b 100%);
            border-color: var(--negative);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
        }
        
        .custom-checkbox:checked::after {
            content: '‚úó';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        
        /* Riga punti calcolati */
        .score-table .calculated {
            background: rgba(0, 0, 0, 0.3);
            font-weight: bold;
            font-size: 1.15em;
            padding: 14px;
            border-top: 1px solid rgba(58, 63, 75, 0.5);
        }
        
        .calculated-row td.mano-label {
            font-size: 1.05em;
            padding: 14px 20px;
        }
        
        .score-table .total-row {
            background: linear-gradient(135deg, var(--accent) 0%, #00c896 100%);
            font-weight: bold;
            font-size: 1.3em;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 166, 126, 0.4);
        }
        
        .score-table .total-row td {
            padding: 18px;
            border: none;
        }
        
        .score-table .total-row td:first-child {
            border-radius: 10px 0 0 10px;
        }
        
        .score-table .total-row td:last-child {
            border-radius: 0 10px 10px 0;
        }
        
        .neg { color: var(--negative); }
        .pos { color: var(--positive); }
        
        .hidden { display: none; }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        /* Animazioni */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px currentColor; }
            50% { box-shadow: 0 0 20px currentColor; }
        }
        
        .pulse { animation: pulse 0.5s ease-in-out; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        
        /* Indicatori Posizione */
        .rank-badge {
            display: inline-block;
            font-size: 1.5em;
            margin-left: 10px;
            vertical-align: middle;
            animation: pulse 0.6s ease-in-out;
        }
        
        .rank-1 { 
            animation: glow 2s ease-in-out infinite;
            color: #FFD700;
            text-shadow: 0 0 10px #FFD700;
        }
        
        .rank-2 { 
            color: #C0C0C0;
            text-shadow: 0 0 8px #C0C0C0;
        }
        
        .rank-3 { 
            color: #CD7F32;
            text-shadow: 0 0 8px #CD7F32;
        }
        
        .score-table th.winner {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            animation: glow 2s ease-in-out infinite;
        }
        
        .score-table th.second {
            background: linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%);
        }
        
        .score-table th.third {
            background: linear-gradient(135deg, #CD7F32 0%, #B8860B 100%);
        }
        
        /* Grafico */
        .chart-container {
            background: var(--bg-card);
            padding: 10px 20px;
            border-radius: 10px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .chart-container.expanded {
            padding: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .chart-header.expanded {
            margin-bottom: 15px;
        }
        
        .chart-header:hover {
            background: rgba(0, 166, 126, 0.1);
        }
        
        .chart-title {
            color: var(--text-secondary);
            font-size: 1.2em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .chart-content.expanded {
            max-height: 500px;
            opacity: 1;
        }
        
        .live-scores {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 0;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .live-score-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .live-score-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .live-score-name {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .live-score-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .live-score-value.neg {
            color: var(--negative);
        }
        
        .live-score-value.pos {
            color: var(--positive);
        }
        
        canvas {
            max-height: 300px;
        }
        
        /* Validazione */
        .validation-warning {
            background: rgba(255, 152, 0, 0.2);
            border-left: 4px solid #ff9800;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            color: #ffb74d;
            font-size: 0.9em;
            animation: slideIn 0.3s ease-out;
        }
        
        .validation-error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid #f44336;
            color: #ef5350;
        }
        
        input.invalid {
            border-color: var(--negative) !important;
            animation: pulse 0.3s ease-in-out;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Schermata Lista Partite -->
    <div id="home-screen">
        <h1>üëë King Scoreboard</h1>
        <div id="partite-list"></div>
    </div>
    
    <!-- Schermata Gioco -->
    <div id="game-screen" class="hidden">
        <div class="game-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h2 class="game-title" id="current-game-title">Nuova Partita</h2>
                <div class="toggle-container">
                    <span class="toggle-label">üèÜ Classifica</span>
                    <div class="toggle-btn active" id="rank-toggle" onclick="toggleRankDisplay()"></div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="tornaHome()">‚Üê Indietro</button>
                <button class="btn btn-danger" onclick="eliminaPartita()">üóëÔ∏è Elimina</button>
            </div>
        </div>
        
        <div class="players-setup">
            <input type="text" id="n1" placeholder="Giocatore 1" oninput="updatePlayersNames()">
            <input type="text" id="n2" placeholder="Giocatore 2" oninput="updatePlayersNames()">
            <input type="text" id="n3" placeholder="Giocatore 3" oninput="updatePlayersNames()">
            <input type="text" id="n4" placeholder="Giocatore 4" oninput="updatePlayersNames()">
        </div>
        
        <div id="validation-messages"></div>
        
        <div class="chart-container" id="chart-container">
            <div class="chart-header" id="chart-header" onclick="toggleChart()">
                <h3 class="chart-title">
                    üìà Andamento Punteggi
                    <span class="expand-icon" id="chart-expand-icon">‚ñº</span>
                </h3>
            </div>
            <div class="live-scores" id="live-scores"></div>
            <div class="chart-content" id="chart-content">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>
        
        <div class="score-table-container">
            <table class="score-table">
                <thead>
                    <tr>
                        <th style="width: 200px;">Mano</th>
                        <th id="h1">G1</th>
                        <th id="h2">G2</th>
                        <th id="h3">G3</th>
                        <th id="h4">G4</th>
                    </tr>
                </thead>
                <tbody id="game-table"></tbody>
                <tfoot>
                    <tr class="total-row">
                        <td>TOTALE</td>
                        <td id="t1">0</td>
                        <td id="t2">0</td>
                        <td id="t3">0</td>
                        <td id="t4">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<script>
    const mani = [
        { nome: 'No K-J', moltiplicatore: -2, tipo: 'carte', icona: 'üëëüÉè', display: '(-2)' },
        { nome: 'No Q', moltiplicatore: -3, tipo: 'carte', icona: 'üë∏', display: '(-3)' },
        { nome: 'No 8 quadri', moltiplicatore: -8, tipo: 'fisso', icona: '‚ô¶Ô∏è8', display: '(-8)' },
        { nome: 'No K cuori', moltiplicatore: -8, tipo: 'fisso', icona: '‚ô•Ô∏èüëë', display: '(-8)' },
        { nome: 'No cuori', moltiplicatore: -1, tipo: 'carte', icona: '‚ô•Ô∏è', display: '(-1)' },
        { nome: 'No U2', moltiplicatore: -4, tipo: 'carte', icona: 'üéØ', display: 'No U2 (-4)' },
        { nome: 'Misere', moltiplicatore: -1, tipo: 'prese', icona: 'üö´', display: 'Misere (-1)' },
        { nome: 'Domino', moltiplicatore: 1, tipo: 'libero', icona: 'üé≤', display: 'Domino (¬±)' },
        { nome: 'I Dich', moltiplicatore: 1, tipo: 'prese', icona: '1Ô∏è‚É£', display: 'I Dich (+1)' },
        { nome: 'II Dich', moltiplicatore: 1, tipo: 'prese', icona: '2Ô∏è‚É£', display: 'II Dich (+1)' },
        { nome: 'III Dich', moltiplicatore: 1, tipo: 'prese', icona: '3Ô∏è‚É£', display: 'III Dich (+1)' },
        { nome: 'IV Dich', moltiplicatore: 1, tipo: 'prese', icona: '4Ô∏è‚É£', display: 'IV Dich (+1)' },
        { nome: 'SansAtout', moltiplicatore: 2, tipo: 'prese', icona: '‚≠ê', display: 'SansAtout (+2)' }
    ];
    
    let partite = JSON.parse(localStorage.getItem('kingPartite') || '[]');
    let currentPartitaId = null;
    let showRankings = false;
    
    // Inizializzazione
    showHomeScreen();
    
    function toggleRankDisplay() {
        showRankings = !showRankings;
        const toggleBtn = document.getElementById('rank-toggle');
        
        if(showRankings) {
            toggleBtn.classList.add('active');
        } else {
            toggleBtn.classList.remove('active');
        }
        
        ricalcolaPunti();
    }
    
    function showHomeScreen() {
        document.getElementById('home-screen').classList.remove('hidden');
        document.getElementById('game-screen').classList.add('hidden');
        renderPartiteList();
    }
    
    function renderPartiteList() {
        const container = document.getElementById('partite-list');
        container.innerHTML = '';
        
        // Card per nuova partita
        const newCard = document.createElement('div');
        newCard.className = 'partita-card new-partita-card';
        newCard.innerHTML = '+';
        newCard.onclick = () => creaPartita();
        container.appendChild(newCard);
        
        // Card partite esistenti
        partite.forEach(partita => {
            const card = document.createElement('div');
            card.className = 'partita-card';
            const data = new Date(partita.data).toLocaleDateString('it-IT');
            const giocatori = partita.giocatori.filter(g => g).join(', ') || 'Giocatori non impostati';
            
            card.innerHTML = `
                <button class="delete-card-btn" onclick="event.stopPropagation(); eliminaPartitaDaHome(${partita.id})">üóëÔ∏è</button>
                <h3>${partita.nome}</h3>
                <div class="partita-info">üìÖ ${data}</div>
                <div class="partita-info">üë• ${giocatori}</div>
            `;
            card.onclick = () => apriPartita(partita.id);
            container.appendChild(card);
        });
    }
    
    function creaPartita() {
        const partita = {
            id: Date.now(),
            nome: `Partita ${partite.length + 1}`,
            data: new Date().toISOString(),
            giocatori: ['', '', '', ''],
            valori: Array(13).fill(null).map(() => [0, 0, 0, 0])
        };
        partite.push(partita);
        salvaPartite();
        apriPartita(partita.id);
    }
    
    function apriPartita(id) {
        currentPartitaId = id;
        const partita = partite.find(p => p.id === id);
        
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('current-game-title').textContent = partita.nome;
        
        // Carica giocatori
        for(let i = 0; i < 4; i++) {
            document.getElementById('n' + (i+1)).value = partita.giocatori[i] || '';
        }
        updatePlayersNames();
        
        // Genera tabella
        generaTabella(partita);
        
        
    }
    
    function generaTabella(partita) {
        const tbody = document.getElementById('game-table');
        tbody.innerHTML = '';
        
        mani.forEach((mano, idx) => {
            // Wrapper per raggruppamento
            const groupRow = tbody.insertRow();
            groupRow.className = 'mano-group';
            
            // Riga punti calcolati
            const calcRow = tbody.insertRow();
            calcRow.id = 'calc-row-' + idx;
            calcRow.className = 'calculated-row';
            calcRow.style.cursor = 'pointer';
            calcRow.onclick = () => toggleManoInput(idx);
            
            const calcLabel = calcRow.insertCell();
            calcLabel.className = 'mano-label';
            calcLabel.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <span class="mano-icon">${mano.icona}</span>
                    <span>${mano.display || mano.nome}</span>
                </div>
                <span class="expand-icon" id="expand-icon-${idx}">‚ñº</span>
            `;
            
            // Calcola quale giocatore √® il mazziere per questa mano
            const dealerIdx = idx % 4;
            
            for(let i = 0; i < 4; i++) {
                const cell = calcRow.insertCell();
                cell.className = 'calculated' + (i === dealerIdx ? ' dealer' : '');
                cell.id = `calc-${idx}-${i}`;
            }
            
            // NON creiamo pi√π la riga input qui - verr√† creata dinamicamente
        });
        
        ricalcolaPunti();
        evidenziaMazziere();
    }
    
    function aggiornaValore(manoIdx, giocatoreIdx, valore) {
        const partita = partite.find(p => p.id === currentPartitaId);
        partita.valori[manoIdx][giocatoreIdx] = valore;
        salvaPartite();
        ricalcolaPunti();
    }
    
    function toggleChart() {
        const content = document.getElementById('chart-content');
        const icon = document.getElementById('chart-expand-icon');
        const container = document.getElementById('chart-container');
        const header = document.getElementById('chart-header');
        
        if(content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            icon.classList.remove('expanded');
            container.classList.remove('expanded');
            header.classList.remove('expanded');
        } else {
            content.classList.add('expanded');
            icon.classList.add('expanded');
            container.classList.add('expanded');
            header.classList.add('expanded');
        }
    }
    
    function aggiornaLiveScores(totali) {
        const partita = partite.find(p => p.id === currentPartitaId);
        const container = document.getElementById('live-scores');
        
        container.innerHTML = totali.map((tot, i) => {
            const nome = partita.giocatori[i] || 'G' + (i+1);
            const colorClass = tot < 0 ? 'neg' : tot > 0 ? 'pos' : '';
            return `
                <div class="live-score-card">
                    <div class="live-score-name">${nome}</div>
                    <div class="live-score-value ${colorClass}">${tot}</div>
                </div>
            `;
        }).join('');
    }
    
    function ricalcolaPunti() {
        const partita = partite.find(p => p.id === currentPartitaId);
        let totali = [0, 0, 0, 0];
        let progressi = []; // Per il grafico
        
        mani.forEach((mano, manoIdx) => {
            const valori = partita.valori[manoIdx];
            const punti = valori.map(v => v * mano.moltiplicatore);
            
            punti.forEach((p, i) => {
                totali[i] += p;
                const cell = document.getElementById(`calc-${manoIdx}-${i}`);
                if(cell) {
                    cell.textContent = p > 0 ? '+' + p : p;
                    cell.className = 'calculated ' + (p < 0 ? 'neg' : p > 0 ? 'pos' : '');
                }
            });
            
            // Salva progressione per il grafico
            progressi.push([...totali]);
        });
        
        // Trova classifiche
        const classifiche = totali.map((tot, idx) => ({ idx, tot })).sort((a, b) => b.tot - a.tot);
        
        // Rimuovi classi precedenti e badge
        for(let i = 1; i <= 4; i++) {
            const header = document.getElementById('h' + i);
            header.className = '';
            // Rimuovi badge esistenti
            const badge = header.querySelector('.rank-badge');
            if(badge) badge.remove();
        }
        
        // Aggiorna totali con animazione
        totali.forEach((tot, i) => {
            const cell = document.getElementById('t' + (i+1));
            const oldValue = parseInt(cell.textContent) || 0;
            cell.textContent = tot;
            cell.className = tot < 0 ? 'neg' : tot > 0 ? 'pos' : '';
            
            // Animazione se il valore √® cambiato
            if(oldValue !== tot) {
                cell.classList.add('pulse');
                setTimeout(() => cell.classList.remove('pulse'), 500);
            }
        });
        
        // Aggiorna punteggi live
        aggiornaLiveScores(totali);
        
        // Aggiungi indicatori 1¬∞, 2¬∞, 3¬∞ solo se showRankings √® true
        if(showRankings) {
            const badges = ['üëë', 'ü•à', 'ü•â'];
            const rankClasses = ['rank-1 winner', 'rank-2 second', 'rank-3 third'];
            
            classifiche.slice(0, 3).forEach((player, rank) => {
                const header = document.getElementById('h' + (player.idx + 1));
                header.classList.add(rankClasses[rank].split(' ')[1]);
                
                const badge = document.createElement('span');
                badge.className = 'rank-badge ' + rankClasses[rank].split(' ')[0];
                badge.textContent = badges[rank];
                header.appendChild(badge);
            });
        }
        
        // Valida input
        validaInput(partita);
        
        // Aggiorna grafico
        aggiornaGrafico(progressi);
    }
    
    function toggleManoInput(manoIdx) {
        const partita = partite.find(p => p.id === currentPartitaId);
        const inputRow = document.getElementById('input-row-' + manoIdx);
        const expandIcon = document.getElementById('expand-icon-' + manoIdx);
        const calcRow = document.getElementById('calc-row-' + manoIdx);
        const mano = mani[manoIdx];
        const dealerIdx = manoIdx % 4;
        
        if(inputRow) {
            // Se esiste, rimuovila
            inputRow.remove();
            expandIcon.classList.remove('expanded');
        } else {
            // Crea la riga dinamicamente
            const tbody = document.getElementById('game-table');
            const calcRowIndex = calcRow.rowIndex;
            const row = tbody.insertRow(calcRowIndex + 1);
            row.className = 'mano-input-row';
            row.id = 'input-row-' + manoIdx;
            
            // Colonna nome mano
            const cellMano = row.insertCell();
            cellMano.className = 'mano-label';
            cellMano.innerHTML = `<span style="opacity: 0.7; font-size: 0.9em; font-style: italic;">‚úèÔ∏è Inserisci valori</span>`;
            
            // Colonne giocatori
            for(let i = 0; i < 4; i++) {
                const cell = row.insertCell();
                
                if(mano.tipo === 'fisso') {
                    // Checkbox stilizzata
                    const check = document.createElement('input');
                    check.type = 'checkbox';
                    check.className = 'custom-checkbox';
                    check.checked = partita.valori[manoIdx][i] === 1;
                    check.onchange = (e) => {
                        aggiornaValore(manoIdx, i, e.target.checked ? 1 : 0);
                    };
                    cell.appendChild(check);
                } else {
                    // Input numerico
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = partita.valori[manoIdx][i];
                    input.min = mano.tipo === 'libero' ? -10 : 0;
                    input.max = mano.tipo === 'libero' ? 10 : 13;
                    input.oninput = (e) => {
                        aggiornaValore(manoIdx, i, parseInt(e.target.value) || 0);
                    };
                    cell.appendChild(input);
                }
            }
            
            expandIcon.classList.add('expanded');
        }
    }
    
    function evidenziaMazziere() {
        // Rimuovi tutte le classi dealer dall'header
        for(let i = 1; i <= 4; i++) {
            document.getElementById('h' + i).classList.remove('dealer');
        }
        
        // Non evidenziare nell'header, solo nelle celle
    }
    
    function updatePlayersNames() {
        const partita = partite.find(p => p.id === currentPartitaId);
        for(let i = 1; i <= 4; i++) {
            const nome = document.getElementById('n'+i).value || 'G'+i;
            document.getElementById('h'+i).textContent = nome;
            partita.giocatori[i-1] = document.getElementById('n'+i).value;
        }
        salvaPartite();
    }
    
    function tornaHome() {
        showHomeScreen();
    }
    
    function eliminaPartita() {
        if(confirm('Sei sicuro di voler eliminare questa partita?')) {
            partite = partite.filter(p => p.id !== currentPartitaId);
            salvaPartite();
            showHomeScreen();
        }
    }
    
    function eliminaPartitaDaHome(id) {
        if(confirm('Sei sicuro di voler eliminare questa partita?')) {
            partite = partite.filter(p => p.id !== id);
            salvaPartite();
            renderPartiteList();
        }
    }
    
    function salvaPartite() {
        localStorage.setItem('kingPartite', JSON.stringify(partite));
    }
    
    // Validazione intelligente
    function validaInput(partita) {
        const messages = [];
        
        mani.forEach((mano, idx) => {
            const valori = partita.valori[idx];
            const somma = valori.reduce((a, b) => a + b, 0);
            
            // Validazione per mani con somma fissa
            if(mano.tipo === 'carte') {
                const maxCarte = mano.nome === 'No cuori' ? 13 : 
                                mano.nome === 'No K-J' ? 8 : 
                                mano.nome === 'No Q' ? 4 : 13;
                
                if(somma > maxCarte) {
                    messages.push({
                        type: 'error',
                        text: `‚ö†Ô∏è ${mano.nome}: totale ${somma} supera il massimo di ${maxCarte} carte!`
                    });
                    
                    // Evidenzia celle errate
                    valori.forEach((v, i) => {
                        if(v > 0) {
                            const inputs = document.querySelectorAll(`#game-table tr:nth-child(${idx*2 + 1}) input`);
                            if(inputs[i]) inputs[i].classList.add('invalid');
                        }
                    });
                }
            }
            
            if(mano.tipo === 'prese' && mano.nome.includes('Dich')) {
                if(somma !== 13 && somma > 0) {
                    messages.push({
                        type: 'warning',
                        text: `üí° ${mano.nome}: somma prese = ${somma}, dovrebbe essere 13`
                    });
                }
            }
            
            if(mano.tipo === 'fisso') {
                if(somma > 1) {
                    messages.push({
                        type: 'error',
                        text: `‚ö†Ô∏è ${mano.nome}: solo un giocatore pu√≤ prenderla!`
                    });
                }
            }
        });
        
        // Mostra messaggi
        const container = document.getElementById('validation-messages');
        container.innerHTML = messages.map(m => 
            `<div class="validation-${m.type}">${m.text}</div>`
        ).join('');
        
        // Rimuovi classi invalid dopo 2 secondi
        setTimeout(() => {
            document.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        }, 2000);
    }
    
    // Grafico con Chart.js semplificato (nativo)
    let chartData = null;
    
    function aggiornaGrafico(progressi) {
        const canvas = document.getElementById('scoreChart');
        const ctx = canvas.getContext('2d');
        const partita = partite.find(p => p.id === currentPartitaId);
        
        // Dimensioni
        canvas.width = canvas.offsetWidth;
        canvas.height = 300;
        const w = canvas.width;
        const h = canvas.height;
        const padding = 40;
        
        // Clear
        ctx.clearRect(0, 0, w, h);
        
        if(progressi.length === 0) return;
        
        // Trova min/max
        let minY = 0, maxY = 0;
        progressi.forEach(punto => {
            punto.forEach(val => {
                if(val < minY) minY = val;
                if(val > maxY) maxY = val;
            });
        });
        
        const rangeY = Math.max(Math.abs(minY), Math.abs(maxY), 10);
        minY = -rangeY;
        maxY = rangeY;
        
        // Funzioni di scala
        const scaleX = (i) => padding + (i / (progressi.length - 1 || 1)) * (w - padding * 2);
        const scaleY = (val) => h - padding - ((val - minY) / (maxY - minY)) * (h - padding * 2);
        
        // Griglia
        ctx.strokeStyle = '#3a3f4b';
        ctx.lineWidth = 1;
        for(let i = 0; i <= 5; i++) {
            const y = padding + (i / 5) * (h - padding * 2);
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(w - padding, y);
            ctx.stroke();
        }
        
        // Linea zero
        ctx.strokeStyle = '#666';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, scaleY(0));
        ctx.lineTo(w - padding, scaleY(0));
        ctx.stroke();
        
        // Colori giocatori
        const colors = ['#00e676', '#00b0ff', '#ffea00', '#ff6e40'];
        
        // Disegna linee
        for(let g = 0; g < 4; g++) {
            ctx.strokeStyle = colors[g];
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            progressi.forEach((punto, i) => {
                const x = scaleX(i);
                const y = scaleY(punto[g]);
                if(i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            
            ctx.stroke();
            
            // Punti finali
            const lastX = scaleX(progressi.length - 1);
            const lastY = scaleY(progressi[progressi.length - 1][g]);
            ctx.fillStyle = colors[g];
            ctx.beginPath();
            ctx.arc(lastX, lastY, 6, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Legenda
        ctx.font = '12px Segoe UI';
        for(let i = 0; i < 4; i++) {
            const nome = partita.giocatori[i] || 'G' + (i+1);
            ctx.fillStyle = colors[i];
            ctx.fillText('‚óè ' + nome, padding + i * 100, h - 10);
        }
    }
</script>

</body>
</html>